<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<style id="dynamicStyle">
		body {
			margin: 0;
			font-family: Arial, sans-serif;
			background-color: #000000;
			/* Twitteré¢¨ã®èƒŒæ™¯è‰² */
			color: #14171a;
			/* æ–‡å­—è‰² */
		}

		.container {
			max-width: 800px;
			margin: auto;
			padding: 20px;
			border: 1px solid #e1e8ed;
			border-radius: 10px;
			background-color: white;
			/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èƒŒæ™¯ */
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		.header {
			text-align: center;
			padding: 20px;
		}

		.header h1 {
			margin: 0;
			font-size: 2.5em;
			color: #1da1f2;
			/* Twitterã®é’è‰² */
		}

		.account-section {
			display: flex;
			justify-content: center;
			/* ä¸­å¤®æƒãˆ */
			margin: 20px 0;
			flex-wrap: wrap;
			/* ãƒœã‚¿ãƒ³ã‚’æŠ˜ã‚Šè¿”ã™ */
		}

		button {
			padding: 10px 20px;
			font-size: 16px;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s;
			background-color: #28a745;
			/* ç·‘è‰² */
		}

		#registerButton,
		#loginButton,
		#profileButton,
		#friendsListButton {
			background-color: #1da1f2;
			/* Twitterã®é’è‰² */
		}

		#followButton {
			background-color: #28a745;
			/* ç·‘è‰² */
		}

		#emergencyButton {
			background-color: #dc3545;
			/* èµ¤è‰² */
		}

		button:hover {
			opacity: 0.9;
			transform: scale(1.05);
			/* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æ‹¡å¤§ */
		}

		.blog-section {
			margin-top: 20px;
			padding: 20px;
			border-radius: 10px;
			background-color: #f0f8ff;
			/* è–„ã„é’è‰² */
		}

		.comments {
			margin-top: 20px;
		}

		textarea {
			width: 100%;
			padding: 10px;
			border-radius: 5px;
			border: 1px solid #ccc;
			margin-bottom: 10px;
		}

		.comment {
			border-bottom: 1px solid #e1e8ed;
			padding: 10px 0;
		}

		.comment span {
			font-weight: bold;
		}

		.reaction-buttons {
			display: flex;
			justify-content: flex-start;
			margin-top: 10px;
		}

		.reaction-button {
			background: transparent;
			border: none;
			color: #1da1f2;
			font-size: 18px;
			cursor: pointer;
			margin-right: 10px;
		}

		.reaction-count {
			margin-left: 5px;
		}

		.footer {
			text-align: center;
			margin-top: 20px;
			font-size: 0.9em;
			color: #657786;
		}

		.video-call-button {
			background-color: #1da1f2;
			/* é’è‰² */
			color: white;
			padding: 10px 20px;
			font-size: 16px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s;
			margin: 10px 0;
		}

		.video-call-button:hover {
			background-color: #0d8bdc;
			/* ãƒ›ãƒãƒ¼æ™‚ã®è‰² */
		}

		.video-call-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.85);
			justify-content: center;
			align-items: center;
			z-index: 9999;
		}

		.video-call-content {
			background-color: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
			text-align: center;
		}

		.close-video-call {
			background-color: transparent;
			border: none;
			font-size: 20px;
			cursor: pointer;
			color: red;
			margin-top: 10px;
		}
	</style>
	<script type="module">
		// Firebaseã®åˆæœŸåŒ–
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYO7lc3tTKdNlK1wLjTTpneQL-zkYU3uA",
            authDomain: "chatapp-by-kbk.firebaseapp.com",
            databaseURL: "https://chatapp-by-kbk-default-rtdb.firebaseio.com",
            projectId: "chatapp-by-kbk",
            storageBucket: "chatapp-by-kbk.appspot.com",
            messagingSenderId: "254822225505",
            appId: "1:254822225505:web:1d8121702659a448fa7c20",
            measurementId: "G-ZPDHPNGVSN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            const blockedUsers = new Set();
            const blockOverlay = document.createElement('div');
            blockOverlay.classList.add('block-overlay');
            const blockText = document.createElement('div');
            blockText.classList.add('block-message-large');
            blockText.textContent = "ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚";
            blockOverlay.appendChild(blockText);
            document.body.appendChild(blockOverlay);

            const onlineUsersRef = collection(db, 'onlineUsers');
            const userActivityRef = collection(db, 'userActivity'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
            const badgesRef = collection(db, "badges"); // ãƒãƒƒã‚¸ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

            // ä¿¡ç”¨ã‚¹ã‚³ã‚¢ã®æ›´æ–°
            const updateTrustScore = async (userId, score) => {
                const userDocRef = doc(db, 'users', userId);
                const userSnap = await getDocs(userDocRef);
                const userData = userSnap.data();

                const newScore = (userData.trustScore || 0) + score;

                await updateDoc(userDocRef, { trustScore: newScore });
            };

            // Online User Functions
            const addOnlineUser = async (userId) => {
                await addDoc(onlineUsersRef, { userId: userId });
            };

            const getOnlineUsers = async () => {
                const snapshot = await getDocs(onlineUsersRef);
                return snapshot.docs.map(doc => doc.data().userId);
            };

            // ãƒãƒƒã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const displayBadges = async (userId) => {
                const userDoc = await getDocs(collection(db, "users"));
                const user = userDoc.docs.find(doc => doc.data().uid === userId)?.data();
                const badgesContainer = document.createElement('div');
                badgesContainer.classList.add('badges');

                if (user) {
                    const badges = user.badges || [];

                    badges.forEach(badge => {
                        const badgeElement = document.createElement('div');
                        badgeElement.classList.add('badge');
                        badgeElement.textContent = badge;
                        badgesContainer.appendChild(badgeElement);
                    });

                    document.body.appendChild(badgesContainer);
                }
            };

            // ãƒãƒƒã‚¸ã‚’ç²å¾—ã™ã‚‹é–¢æ•°
            const awardBadge = async (userId, badge) => {
                const userDocRef = doc(db, 'users', userId);
                const userSnap = await getDocs(userDocRef);
                const userData = userSnap.data();

                const badges = userData.badges || [];

                if (!badges.includes(badge)) {
                    badges.push(badge);
                    await updateDoc(userDocRef, { badges: badges });
                    alert(`ãƒãƒƒã‚¸ã€Œ${badge}ã€ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
                    displayBadges(userId); // ãƒãƒƒã‚¸ã‚’å†è¡¨ç¤º
                }
            };

            // ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('followButton').onclick = async function () {
                await updateTrustScore(userId, 1); // ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢è¿½åŠ 
                const userDocRef = doc(db, 'users', userId);
                const userSnap = await getDocs(userDocRef);
                const userData = userSnap.data();

                // ãƒãƒƒã‚¸ã‚’ç²å¾—
                if (userData.followers.length === 9) { // 9äººç›®ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼
                    await awardBadge(userId, "10äººãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼");
                }
            };

            // ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
            const commentInput = document.getElementById('commentInput');
            const submitCommentButton = document.getElementById('submitComment');
            const commentList = document.getElementById('commentList');
            const showMoreButton = document.getElementById('showMoreButton');
            const passwordInput = document.getElementById('passwordInput');
            const deleteCommentsButton = document.getElementById('deleteCommentsButton');
            const emergencyButton = document.getElementById('emergencyButton');

            const usernameInput = document.getElementById('usernameInput');
            const registerButton = document.getElementById('registerButton');
            const loginButton = document.getElementById('loginButton');
            const userStatus = document.getElementById('userStatus');

            const profilePopup = document.createElement('div');
            profilePopup.classList.add('profile-popup');

            let userId = null;
            let username = null;
            let userComment = ""; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ
            let following = new Set(); // ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ ¼ç´ã™ã‚‹ã‚»ãƒƒãƒˆ

            // ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã®é–¢æ•°
            const toggleStyles = () => {
                const currentStyle = document.getElementById('dynamicStyle');
                if (currentStyle.innerHTML.includes('background-color: #000000')) {
                    currentStyle.innerHTML = `
                    body {
                        background-image: url('https://th.bing.com/th/id/OIG2.Wnln.UlFDTVAyzs4L3a2?pid=ImgGn');
                        background-size: cover;
                        background-position: center;
                        margin: 0;
                        font-family: Arial, sans-serif;
                    }

                    .large-text {
                        font-size: 48px;
                        font-weight: bold;
                        text-align: center;
                        color: white;
                        margin-top: 20px;
                    }

                    /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
                    #followButton,
                    #aboutBlankButton,
                    #emergencyButton,
                    #proxyButton,
                    #registerButton,
                    #loginButton,
                    #profileButton,
                    #friendsListButton {
                        display: block;
                        margin: 20px auto;
                        padding: 10px 20px;
                        font-size: 24px;
                        font-weight: bold;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        transition: background-color 0.3s;
                    }

                    /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–¢é€£ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç·‘ã«å¤‰æ›´ */
                    #registerButton,
                    #loginButton,
                    #profileButton {
                        background-color: #28a745; /* ç·‘è‰² */
                    }

                    #registerButton:hover,
                    #loginButton:hover,
                    #profileButton:hover {
                        background-color: #218838; /* ãƒ›ãƒãƒ¼æ™‚ã®è‰² */
                    }

                    #followButton:hover {
                        background-color: #0056b3;
                    }

                    #aboutBlankButton {
                        background-color: #28a745;
                    }

                    #aboutBlankButton:hover {
                        background-color: #218838;
                    }

                    #emergencyButton {
                        background-color: #dc3545;
                    }

                    #emergencyButton:hover {
                        justify-content: center;
                        align-items: center;
                    }

                    .close-button {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        font-size: 24px;
                        color: white;
                        cursor: pointer;
                    }

                    .block-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.85);
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                    }

                    .block-message-large {
                        font-size: 32px;
                        color: white;
                        text-align: center;
                    }

                    .user-list {
                        padding: 20px;
                        background-color: white;
                        border-radius: 10px;
                        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                        max-width: 300px;
                        text-align: center;
                    }

                    .profile-popup {
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: white;
                        border-radius: 10px;
                        padding: 20px;
                        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                        z-index: 1001;
                        display: none;
                    }

                    .profile-popup h3 {
                        margin-top: 0;
                    }

                    .popup-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        display: none;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    }

                    .profile-form {
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        width: 300px;
                    }

                    .profile-actions {
                        display: flex;
                        justify-content: space-between;
                    }

                    .iframe-container {
                        position: relative;
                        width: 100%;
                        height: 100%;
                        background: white;
                        border: none;
                    }

                    /* å‹é”ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
                    .friend-list {
                        margin: 20px;
                        padding: 10px;
                        background: rgba(255, 255, 255, 0.9);
                        border-radius: 10px;
                        max-width: 300px;
                    }

                    .friend {
                        padding: 5px;
                        cursor: pointer;
                        border-bottom: 1px solid #ccc;
                    }

                    .friend:hover {
                        background-color: #eee;
                    }

                    .badge {
                        background-color: #ffd700; /* ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚¸ */
                        color: black;
                        padding: 10px;
                        border-radius: 5px;
                        display: inline-block;
                        margin: 5px;
                    }

                    /* robots.txt åå‰ã®å¤‰æ›´ã‚¹ã‚¿ã‚¤ãƒ« */
                    @keyframes colorChange {
                        0% { color: red; }
                        25% { color: orange; }
                        50% { color: yellow; }
                        75% { color: green; }
                        100% { color: blue; }
                    }
                    `;
                } else {
                    currentStyle.innerHTML = `
                    body {
                        margin: 0;
                        font-family: Arial, sans-serif;
                        background-color: #000000; /* Twitteré¢¨ã®èƒŒæ™¯è‰² */
                        color: #14171a; /* æ–‡å­—è‰² */
                    }

                    .container {
                        max-width: 800px;
                        margin: auto;
                        padding: 20px;
                        border: 1px solid #e1e8ed;
                        border-radius: 10px;
                        background-color: white; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èƒŒæ™¯ */
                        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                    }

                    .header {
                        text-align: center;
                        padding: 20px;
                    }

                    .header h1 {
                        margin: 0;
                        font-size: 2.5em;
                        color: #1da1f2; /* Twitterã®é’è‰² */
                    }

                    .account-section {
                        display: flex;
                        justify-content: center; /* ä¸­å¤®æƒãˆ */
                        margin: 20px 0;
                        flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ã‚’æŠ˜ã‚Šè¿”ã™ */
                    }

                    button {
                        padding: 10px 20px;
                        font-size: 16px;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        transition: background-color 0.3s;
                        background-color: #28a745; /* ç·‘è‰² */
                    }

                    #registerButton, #loginButton, #profileButton, #friendsListButton {
                        background-color: #1da1f2; /* Twitterã®é’è‰² */
                    }

                    #followButton {
                        background-color: #28a745; /* ç·‘è‰² */
                    }

                    #emergencyButton {
                        background-color: #dc3545; /* èµ¤è‰² */
                    }

                    button:hover {
                        opacity: 0.9;
                        transform: scale(1.05); /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æ‹¡å¤§ */
                    }

                    .blog-section {
                        margin-top: 20px;
                        padding: 20px;
                        border-radius: 10px;
                        background-color: #f0f8ff; /* è–„ã„é’è‰² */
                    }

                    .comments {
                        margin-top: 20px;
                    }

                    textarea {
                        width: 100%;
                        padding: 10px;
                        border-radius: 5px;
                        border: 1px solid #ccc;
                        margin-bottom: 10px;
                    }

                    .comment {
                        border-bottom: 1px solid #e1e8ed;
                        padding: 10px 0;
                    }

                    .comment span {
                        font-weight: bold;
                    }

                    .reaction-buttons {
                        display: flex;
                        justify-content: flex-start;
                        margin-top: 10px;
                    }

                    .reaction-button {
                        background: transparent;
                        border: none;
                        color: #1da1f2;
                        font-size: 18px;
                        cursor: pointer;
                        margin-right: 10px;
                    }

                    .reaction-count {
                        margin-left: 5px;
                    }

                    .footer {
                        text-align: center;
                        margin-top: 20px;
                        font-size: 0.9em;
                        color: #657786;
                    }
                    `;
                }
            };

            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æˆ»ã™ãƒœã‚¿ãƒ³ã®è¿½åŠ 
            const resetStyleButton = document.createElement('button');
            resetStyleButton.textContent = 'ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æˆ»ã™';
            resetStyleButton.onclick = toggleStyles;
            document.body.appendChild(resetStyleButton);

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const showProfilePopup = async (user) => {
                const followersCount = user.followers.length; // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°
                const followingCount = following.size; // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹æ•°

                const profileImage = user.profileImage ? `<img src="${user.profileImage}" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" class="profile-image"/>` : '';
                
                profilePopup.innerHTML = `
                    <h3>${user.username}ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                    ${profileImage}
                    <input type="text" id="profileCommentInput" placeholder="ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ" value="${user.comment || ''}" />
                    <div>ãƒ•ã‚©ãƒ­ãƒ¼æ•°: ${followingCount}</div>
                    <div>ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°: ${followersCount}</div>
                    <div>ä¿¡ç”¨ã‚¹ã‚³ã‚¢: ${user.trustScore || 0}</div>
                    <div class="badges"></div>
                    ${user.uid === userId ? 
                        `<button id="saveProfileButton">ä¿å­˜</button>` : 
                        '<button id="followUserButton">ãƒ•ã‚©ãƒ­ãƒ¼</button>'}
                    <button class='closePopup'>é–‰ã˜ã‚‹</button>
                `;
                profilePopup.style.display = 'block'; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
                await displayBadges(user.uid); // ãƒãƒƒã‚¸ã‚’è¡¨ç¤º

                document.body.appendChild(profilePopup);
                profilePopup.querySelector('.closePopup').onclick = () => {
                    profilePopup.style.display = 'none'; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                    profilePopup.remove();
                };

                if (user.uid === userId) {
                    profilePopup.querySelector('#saveProfileButton').onclick = async () => {
                        const updatedComment = profilePopup.querySelector('#profileCommentInput').value;
                        await updateDoc(doc(db, 'users', user.uid), { 
                            comment: updatedComment 
                        });
                        userComment = updatedComment; // ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿æŒ
                        userStatus.textContent = `ã‚ˆã†ã“ãã€${user.username}ã•ã‚“ï¼ã‚³ãƒ¡ãƒ³ãƒˆ: ${userComment}`;
                        profilePopup.style.display = 'none'; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                        profilePopup.remove();
                    };
                } else {
                    profilePopup.querySelector('#followUserButton').onclick = async () => {
                        if (!userId) {
                            alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        // ãƒ•ã‚©ãƒ­ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
                        if (following.has(user.uid)) {
                            alert('æ—¢ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã™ã€‚');
                        } else {
                            following.add(user.uid);
                            await updateDoc(doc(db, 'users', user.uid), { followers: [...user.followers, userId] });
                            await updateDoc(doc(db, 'users', userId), {
                                following: [...following] // è‡ªåˆ†ã®ãƒ•ã‚©ãƒ­ãƒ¼æ•°ã‚’æ›´æ–°
                            });
                            await updateTrustScore(userId, 1); // ã‚¹ã‚³ã‚¢è¿½åŠ 
                            alert('ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼');
                            profilePopup.querySelector('#followUserButton').textContent = "ãƒ•ã‚©ãƒ­ãƒ¼æ¸ˆã¿"; // ãƒœã‚¿ãƒ³å¤‰æ›´
                        }
                    };
                }
            };

            const registerButtonHandler = async () => {
                const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„:");
                const usernameInputValue = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");

                if (!password || !usernameInputValue) {
                    alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    userId = Date.now().toString(); // ä»®ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç”Ÿæˆ
                    username = usernameInputValue;
                    await addDoc(collection(db, "users"), { uid: userId, username: username, password: password, followers: [], following: [], comment: "", profileImage: "", trustScore: 0, badges: [] }); // trustScoreã‚’åˆæœŸåŒ–
                    alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼');
                    userStatus.textContent = `ã‚ˆã†ã“ãã€${username}ã•ã‚“ï¼`;
                } catch (error) {
                    alert('ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            registerButton.onclick = registerButtonHandler;

            loginButton.onclick = async () => {
                const usernameInputValue = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
                const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");

                const userSnapshot = await getDocs(collection(db, "users"));
                let userFound = false;

                userSnapshot.docs.forEach(doc => {
                    if (doc.data().username === usernameInputValue) {
                        userFound = true;
                        if (doc.data().password === password) {
                            userId = doc.data().uid;
                            username = doc.data().username;
                            userComment = doc.data().comment; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
                            following = new Set(doc.data().following); // ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æƒ…å ±ã‚’ä¿æŒ
                            alert('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼');
                            userStatus.innerHTML = `ã‚ˆã†ã“ãã€${username}ã•ã‚“ï¼ã‚³ãƒ¡ãƒ³ãƒˆ: ${userComment}`;
                        } else {
                            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                        }
                    }
                });

                if (!userFound) {
                    alert('ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
                }
            };

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼
            const profileButton = document.getElementById('profileButton');
            profileButton.onclick = async function () {
                if (!userId) {
                    alert('ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                const userSnapshot = await getDocs(collection(db, "users"));
                const user = userSnapshot.docs.find(doc => doc.data().uid === userId)?.data();
                if (user) {
                    showProfilePopup(user);
                } else {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }
            };

            // Submit Comment
            const submittedComments = new Set(); 
            let allComments = [];
            let commentsVisible = 3; 

            submitCommentButton.onclick = async function () {
                const comment = commentInput.value.trim();

                if (!comment) {
                    alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const now = Date.now();
                const commentKey = `${username}:${comment}`;
                if (submittedComments.has(commentKey)) {
                    alert('åŒã˜ã‚³ãƒ¡ãƒ³ãƒˆã¯é€ä¿¡ã§ãã¾ã›ã‚“ã€‚');
                    return;
                }

                if (comment.length > 200) {
                    alert('ã‚³ãƒ¡ãƒ³ãƒˆã¯200æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const newCommentRef = await addDoc(collection(db, "comments"), {
                    name: username || "ã‚²ã‚¹ãƒˆ", 
                    userId: userId || "guest_user", 
                    comment: comment,
                    timestamp: now,
                    likes: 0,
                    anger: 0
                });

                allComments.push({ name: username || "ã‚²ã‚¹ãƒˆ", comment, timestamp: now, id: newCommentRef.id, userId: userId || "guest_user", likes: 0, anger: 0 });
                updateCommentDisplay();
                submittedComments.add(commentKey); 

                // ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ•°ã‚’è¨˜éŒ²ã—ã¦ä¿¡é ¼ã‚¹ã‚³ã‚¢ã‚’å¢—åŠ 
                await updateTrustScore(userId || "guest_user", 1); // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’å¢—åŠ ã•ã›ã€ã‚¹ã‚³ã‚¢ã‚’åŠ ç®—

                // ã‚³ãƒ¡ãƒ³ãƒˆãŒ50ä»¶ã‚’è¶…ãˆãŸå ´åˆã®å‰Šé™¤
                if (allComments.length >= 50) {
                    await deleteAllComments();
                }

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                commentInput.value = '';

                await addOnlineUser(userId || "guest_user");
            };

            async function deleteAllComments() {
                const commentsSnapshot = await getDocs(collection(db, "comments"));
                const deletePromises = commentsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                alert('ã‚³ãƒ¡ãƒ³ãƒˆãŒ50ä»¶ã‚’è¶…ãˆãŸãŸã‚ã€ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                updateCommentDisplay();
            }

            onSnapshot(collection(db, "comments"), async (snapshot) => {
                allComments = [];

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    allComments.push({ ...data, id: doc.id });
                }

                allComments.sort((a, b) => b.timestamp - a.timestamp);
                updateCommentDisplay();
            });

            showMoreButton.onclick = () => {
                commentsVisible = allComments.length; 
                updateCommentDisplay();
                showMoreButton.classList.add('hidden-comments'); 
            };

            // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼
            deleteCommentsButton.onclick = async function () {
                const inputPassword = passwordInput.value.trim();

                if (checkPassword(inputPassword)) {
                    await deleteAllComments();
                    passwordInput.value = '';
                    alert('å…¨ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                } else {
                    alert('ç„¡åŠ¹ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚');
                }
            };

            function checkPassword(inputPassword) {
                return inputPassword === '0122333'; 
            }

            emergencyButton.onclick = async function () {
                const emergencyPassword = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
                if (checkPassword(emergencyPassword)) {
                    const deleteInterval = setInterval(async () => {
                        const commentsSnapshot = await getDocs(collection(db, "comments"));
                        if (commentsSnapshot.size > 0) {
                            await deleteAllComments();
                        }
                    }, 1000);

                    setTimeout(() => {
                        clearInterval(deleteInterval);
                        alert('éå¸¸ç”¨æ©Ÿèƒ½ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚');
                    }, 120000);
                } else {
                    alert('ç„¡åŠ¹ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚');
                }
            };

            function updateCommentDisplay() {
                commentList.innerHTML = '';
                const commentsToDisplay = allComments.slice(0, commentsVisible);

                commentsToDisplay.forEach((data) => {
                    const newComment = document.createElement('div');
                    newComment.classList.add('comment');

                    const usernameLink = document.createElement('span');
                    usernameLink.textContent = data.name;
                    usernameLink.style.cursor = 'pointer';

                    if (data.name === "robots.txt") {
                        usernameLink.style.animation = "colorChange 3s infinite"; // 3ç§’é–“ã®è‰²å¤‰æ›´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    }

                    usernameLink.onclick = async () => {
                        const userSnapshot = await getDocs(collection(db, "users"));
                        const user = userSnapshot.docs.find(doc => doc.data().uid === data.userId)?.data();

                        if (user) {
                            showProfilePopup(user);
                        } else {
                            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    };

                    newComment.appendChild(usernameLink);
                    newComment.appendChild(document.createTextNode(` (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${data.userId}): ${data.comment}`));

                    const timestamp = new Date(data.timestamp).toLocaleString();
                    const timestampElement = document.createElement('div');
                    timestampElement.classList.add('timestamp');
                    timestampElement.textContent = `æŠ•ç¨¿æ—¥: ${timestamp}`;

                    const reactionButtons = document.createElement('div');
                    reactionButtons.classList.add('reaction-buttons');

                    const likeButton = document.createElement('button');
                    likeButton.classList.add('reaction-button');
                    likeButton.textContent = 'ğŸ‘';
                    likeButton.onclick = async () => {
                        data.likes++;
                        await updateDoc(doc(db, "comments", data.id), { likes: data.likes });
                        updateCommentDisplay();
                    };

                    const angerButton = document.createElement('button');
                    angerButton.classList.add('reaction-button');
                    angerButton.textContent = 'ğŸ˜¡';
                    angerButton.onclick = async () => {
                        data.anger++;
                        await updateDoc(doc(db, "comments", data.id), { anger: data.anger });
                        updateCommentDisplay();
                    };

                    const likeCount = document.createElement('span');
                    likeCount.classList.add('reaction-count');
                    likeCount.textContent = `(${data.likes})`;

                    const angerCount = document.createElement('span');
                    angerCount.classList.add('reaction-count');
                    angerCount.textContent = `(${data.anger})`;

                    reactionButtons.appendChild(likeButton);
                    reactionButtons.appendChild(likeCount);
                    reactionButtons.appendChild(angerButton);
                    reactionButtons.appendChild(angerCount);

                    newComment.appendChild(reactionButtons);
                    newComment.appendChild(timestampElement);
                    commentList.appendChild(newComment);
                });
            }

            // å‹é”ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            const showFriendsList = async () => {
                const friendListContainer = document.createElement('div');
                friendListContainer.classList.add('friend-list');

                const userDoc = await getDocs(collection(db, "users"));
                const currentUser = userDoc.docs.find(doc => doc.data().uid === userId)?.data();
                const friends = currentUser ? currentUser.following : [];

                if (friends.length === 0) {
                    friendListContainer.innerHTML = '<p>ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>';
                } else {
                    friends.forEach(async (friendId) => {
                        const friendDoc = userDoc.docs.find(doc => doc.data().uid === friendId);
                        if (friendDoc) {
                            const friendData = friendDoc.data();
                            const friendElement = document.createElement('div');
                            friendElement.classList.add('friend');
                            friendElement.textContent = friendData.username;

                            friendElement.onclick = () => {
                                showProfilePopup(friendData); // ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                            };

                            friendListContainer.appendChild(friendElement);
                        }
                    });
                }

                const overlay = document.createElement('div');
                overlay.classList.add('popup-overlay');
                overlay.appendChild(friendListContainer);

                const closeFriendListButton = document.createElement('button');
                closeFriendListButton.textContent = 'é–‰ã˜ã‚‹';
                closeFriendListButton.onclick = () => {
                    overlay.style.display = 'none';
                    document.body.removeChild(overlay);
                };
                overlay.appendChild(closeFriendListButton);

                document.body.appendChild(overlay);
                overlay.style.display = 'flex';
            };

            // å‹é”ãƒªã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('friendsListButton').onclick = showFriendsList;

            // ãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('proxyButton').onclick = function () {
                const overlay = document.createElement('div');
                overlay.classList.add('popup-overlay');
                overlay.innerHTML = `
                    <div class="fullscreen-overlay">
                        <button class="close-button">âœ–</button>
                        <div class="iframe-container">
                            <iframe src="https://neon.go4it.com.mx" allowfullscreen></iframe>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
                overlay.style.display = 'flex';

                overlay.querySelector('.close-button').onclick = function () {
                    overlay.style.display = 'none';
                    document.body.removeChild(overlay);
                };
            };

            // Cookieã®æ‰¿èª
            const cookieNotice = document.getElementById('cookie-notice');
            cookieNotice.style.display = 'block';

            document.getElementById('accept-btn').onclick = () => {
                cookieNotice.style.display = 'none';
                // ã“ã“ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨±å¯ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
            };

            document.getElementById('reject-btn').onclick = () => {
                cookieNotice.style.display = 'none';
                // ã“ã“ã«ã‚¯ãƒƒã‚­ãƒ¼ã‚’æ‹’å¦ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
            };
        });

                document.getElementById('videoCallButton').onclick = () => {
            const overlay = document.getElementById('videoCallOverlay');
            overlay.style.display = 'flex'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        };

        document.querySelector('.close-video-call').onclick = () => {
            const overlay = document.getElementById('videoCallOverlay');
            overlay.style.display = 'none'; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
        };

        document.getElementById('videoCallButton').onclick = () => {
    window.open("https://bellbird.dmm.com/app/meeting/830gTMnaEe-Rc2OB9RBc4g", "_blank"); 
};

    </script>
</head>

<body>
	<div class="large-text">made by minotaur</div>

	<div class="account-section">
		<button id="registerButton">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
		<button id="loginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
		<button id="profileButton">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä½œæˆ/ç·¨é›†</button>
		<button id="friendsListButton">å‹é”ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
		<div id="userStatus"></div>
	</div>

	<button id="followButton">proxy_minotaurã‚’ãƒ•ã‚©ãƒ­ãƒ¼</button>
	<button id="aboutBlankButton">about:blankã‚’é–‹ã</button>
	<button id="proxyButton">ãƒ—ãƒ­ã‚­ã‚·ã‚’èµ·å‹•</button>

	<div class="blog-section">
		<h2>ãƒ–ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³</h2>
		<p>FirebaseAPIã‚’ä½¿ç”¨ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä¸–ç•Œä¸­ã®äººã¨è©±ã›ã‚‹ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€minoã•ã‚“ã®ãƒãƒ£ãƒƒãƒˆã‚’æŒã£ã¦æ¥ã¾ã—ãŸã€‚(ã†ã¾ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’é¡˜ã„ã¾ã™)ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€   ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€å…¬å¼ã‚¹ã‚¿ã‚¸ã‚ªhttps://scratch.mit.edu/studios/35947626/
		</p>
		<p>ãƒãƒ£ãƒƒãƒˆã®ãƒ«ãƒ¼ãƒ«ã§ã™æ–°è¦ã®æ–¹ã¯ãŠèª­ã¿ãã ã•ã„ã€€https://scratch.mit.edu/projects/1100489494/</p>
		<p>ãƒ“ãƒ‡ã‚ªé€šè©±ã¯ç›¸å¯¾æ¦‚å¿µã¨ã—ã¦åã™ã‚‹ã¨æ€ã£ãŸã®ã§å»ƒæ­¢ã—ã¾ã—ãŸã€‚ã‚³ãƒ¡æ¶ˆã™ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼ˆä¸€éƒ¨instanceã§ã¯æœ€æ–°ã•ã‚Œãªã„æã‚Œã‚ã‚Šï¼‰</p>
		<div class="comments">
			<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›" rows="4"></textarea>
			<button id="submitComment">ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡</button>
			<div id="commentList"></div>
			<button id="showMoreButton">ã™ã¹ã¦è¡¨ç¤º</button>

			<div class="delete-section">
				<input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
				<button id="deleteCommentsButton">ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤</button>
			</div>
		</div>
	</div>

	<div class="video-call-overlay" id="videoCallOverlay">
		<div class="video-call-content">
			<h3>ãƒ“ãƒ‡ã‚ªé€šè©±ã‚’é–‹å§‹</h3>
			<iframe src="https://bellbird.dmm.com/app/meeting/830gTMnaEe-Rc2OB9RBc4g" width="400" height="300"
				frameborder="0" allowfullscreen></iframe>
			<button class="close-video-call">âœ– é–‰ã˜ã‚‹</button>
		</div>
	</div>

	<!-- Cookieã®æ‰¿èª -->
	<div id="cookie-notice" class="cookie-notice">
		æœ€æ–°ã®YUKIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¨ã¶ã€‚<br>
		<button id="accept-btn">OKï¼ˆYUKIã«ã¨ã¶ï¼‰</button>
		<button id="reject-btn">NOï¼ˆãƒãƒ£ãƒƒãƒˆã«ã¨ã©ã¾ã‚‹ï¼‰</button>
	</div>

	<script src="script.js"></script>
</body>

</html>
